### <a name="_b7urdng99y53"></a>**Название задачи:** Проектирование шагов Saga
### <a name="_hjk0fkfyohdk"></a>**Автор:** Гуреев Евгений
### <a name="_uanumrh8zrui"></a>**Дата:** январь 2026


## Контекст и ключевые требования

Обработка платежа в OrchestrPay представляет собой длительную бизнес-транзакцию (Long-Running Transaction, LRT), которая охватывает несколько сервисов и внешних систем. Для обеспечения целостности данных и согласованности состояния при сбоях выбран подход Saga-оркестрации.

Критичные ограничения, определившие дизайн:
- Финансовая безопасность: Недопустимо зависание средств между системами
- Приоритет безопасности: Стоимость ошибки проведения транзакции выше, чем её отклонения
- Автоматизация: Возвраты должны выполняться без ручного вмешательства
- Сложность состояний: Необходимость обработки трёх исходов антифрод-проверки (разрешение/запрет/ручная проверка)


## Реестр транзакций Saga-оркестрации платёжного процесса OrchestrPay (ядро процесса)

| Транзакция | Описание | Тип | Компенсация |
|-------------------------------|-----------------------------------------------|----------------|------------------|
| CREATE_PAYMENT | Создание записи о платеже с начальным статусом (PENDING). Фиксация параметров | повторяемая | — |
| RESERVE_FUNDS | Резервирование (блокировка) средств на счёте | компенсируемая | RELEASE_FUNDS |
| DEBIT_FUNDS | Фактическое списание заблокированных средств со счёта | компенсируемая | REFUND_FUNDS |
| REQUEST_FRAUD_CHECK | Отправка транзакции на проверку во внутренний и внешние антифрод-сервисы | повторяемая | — |
| PROCESS_MANUAL_REVIEW | Обработка сценария ручной проверки: создание задачи, ожидание решения оператора (до 20 мин), обработка таймаута (cut-off) | повторяемая | — |
| CREDIT_MERCHANT | Точка невозврата: Перевод средств контрагенту. Выполняется только после финального одобрения | необратимая | — |
| REFUND_FUNDS | Возврат списанных средств клиенту. Запускается при отказе или сбое после DEBIT_FUNDS, но до CREDIT_MERCHANT | необратимая | — (компенсация) |
| RELEASE_FUNDS | Разблокировка зарезервированных (но ещё не списанных) средств | повторяемая | — (компенсация) |
| NOTIFY_PARTIES | Отправка уведомлений клиенту и службе безопасности (в зависимости от итогового статуса) | повторяемая | — |


### Принципы классификации транзакций

Транзакции по возможности отката и идемпотентности:

#### Компенсируемые транзакции

Создают бизнес-эффект, который обязательно можно откатить в рамках Saga:
- `RESERVE_FUNDS` - блокировка средств на счёте клиента. Компенсация: `RELEASE_FUNDS`
- `DEBIT_FUNDS` - фактическое списание. Компенсация: `REFUND_FUNDS`

**Важно**: Эти транзакции выполняются до `точки невозврата`, чтобы обеспечить возможность полного отката.

#### Точка невозврата
- `CREDIT_MERCHANT` - перевод средств контрагенту. После успешного выполнения этой операции компенсация невозможна в автоматическом режиме. Все проверки должны быть завершены до этого момента.

#### Повторяемые транзакции

Безопасно повторяемые операции:
- `CREATE_PAYMENT` - создание записи о платеже
- `REQUEST_FRAUD_CHECK` - запрос к антифрод-сервисам (кэширование результата)
- `PROCESS_MANUAL_REVIEW` - обработка сценария ручной проверки
- `NOTIFY_PARTIES` - отправка уведомлений


### Сценарии

Успешное выполнение:
1. `CREATE_PAYMENT` --> `RESERVE_FUNDS` --> `DEBIT_FUNDS`
2. `REQUEST_FRAUD_CHECK` (получение `ALLOW`)
3. `CREDIT_MERCHANT` (точка невозврата)
4. `NOTIFY_PARTIES` (успех)

Ручная проверка:
1. `CREATE_PAYMENT` --> `RESERVE_FUNDS` --> `DEBIT_FUNDS`
2. `REQUEST_FRAUD_CHECK` (получение `MANUAL_REVIEW`)
3. `PROCESS_MANUAL_REVIEW`:
   - Создание запроса оператору
   - Ожидание 20 минут
   - Если нет решения - автоматическое разрешение
4. После решения (`ALLOW`/`DENY`):
   - `ALLOW` --> `CREDIT_MERCHANT` --> `NOTIFY_PARTIES` (успех)
   - `DENY` --> `REFUND_FUNDS` --> `NOTIFY_PARTIES` (отказ + уведомление безопасности)

Отказ на этапе проверок:
1. `CREATE_PAYMENT` --> `RESERVE_FUNDS` --> `DEBIT_FUNDS`
2. `REQUEST_FRAUD_CHECK` (получение `DENY`)
3. `REFUND_FUNDS` (возврат средств)
4. `NOTIFY_PARTIES` (отказ + уведомление безопасности)

